Introduced a shared Stage 3 sheet constant, updated the CLI default/help text, and added friendly validation before loading or visualizing Stage 4 anomalies.

Reused the Stage 3 sheet default across the anomaly visualizer’s color application and legend helpers to keep downstream tooling aligned.

Documented the Stage 4 reliance on the Stage 3 통합_원본데이터_Fixed worksheet in the pipeline README.

Testing

❌ pytest -q (fails: HVDC_Invoice_Audit/01_DSV_SHPT/Core_Systems/test_atcost_pdf_parsing.py exits when fixture PDF is missing)


파일 (3)개

hvdc_pipeline/README.md
+1
-0

hvdc_pipeline/scripts/stage4_anomaly/anomaly_detector.py
+48
-4

hvdc_pipeline/scripts/stage4_anomaly/anomaly_visualizer.py
+10
-4

diff --git a/hvdc_pipeline/README.md b/hvdc_pipeline/README.md
index f03910e0c87228c0edf4d537907ba153e5ac0b5f..357e2cff1fc7dd5d3c9c29e7f8d787b7810124a8 100644
--- a/hvdc_pipeline/README.md
+++ b/hvdc_pipeline/README.md
@@ -51,50 +51,51 @@ hvdc_pipeline/
 ```

 ## 🔄 파이프라인 단계

 ### Stage 1: 데이터 동기화 (Data Synchronization)
 - 원본 데이터 로드 및 정제
 - 컬럼 정규화 및 타입 변환
 - 동기화된 데이터 출력

 ### Stage 2: 파생 컬럼 생성 (Derived Columns)
 - **13개 파생 컬럼** 자동 계산:
   - **상태 관련 (6개)**: Status_SITE, Status_WAREHOUSE, Status_Current, Status_Location, Status_Location_Date, Status_Storage
   - **처리량 관련 (5개)**: Site_AGI_handling, WH_AGI_handling, Total_AGI_handling, Minus, Final_AGI_handling
   - **분석 관련 (2개)**: Stack_Status, SQM
 - 벡터화 연산으로 고성능 처리

 ### Stage 3: 보고서 생성 (Report Generation)
 - 다중 시트 Excel 보고서 생성
 - 창고별/사이트별 분석
 - KPI 대시보드

 ### Stage 4: 이상치 탐지 (Anomaly Detection)
 - 통계적 이상치 탐지
 - 시각화 및 분석 리포트
 - 예외 케이스 식별
+- Stage 3 산출물인 **통합_원본데이터_Fixed** 시트를 기본으로 사용하며, 다른 시트를 사용하려면 `--sheet` 옵션을 지정합니다.

 ## 🛠️ 설치 및 실행

 ### 1. 의존성 설치
 ```bash
 pip install -r requirements.txt
 ```

 ### 2. 전체 파이프라인 실행
 ```bash
 python run_pipeline.py --all
 ```

 ### 3. 특정 Stage만 실행
 ```bash
 # Stage 2만 실행 (파생 컬럼 생성)
 python run_pipeline.py --stage 2

 # Stage 1, 2 실행
 python run_pipeline.py --stage 1,2
 ```

 ## ⚙️ 설정

 설정 파일은 `config/` 디렉토리에 YAML 형식으로 저장됩니다:
diff --git a/hvdc_pipeline/scripts/stage4_anomaly/anomaly_detector.py b/hvdc_pipeline/scripts/stage4_anomaly/anomaly_detector.py
index 54d5d2640a76175a08dfd84e8330bdae4868f696..4a740e0ce12d002feafe2746afdf34e2dcf7f7f8 100644
--- a/hvdc_pipeline/scripts/stage4_anomaly/anomaly_detector.py
+++ b/hvdc_pipeline/scripts/stage4_anomaly/anomaly_detector.py
@@ -26,50 +26,54 @@ try:
     from sklearn.preprocessing import StandardScaler

     SKLEARN_AVAILABLE = True
 except Exception:
     SKLEARN_AVAILABLE = False
     IsolationForest = object  # type: ignore
     StandardScaler = object  # type: ignore

 try:
     import openpyxl
     from openpyxl.styles import Font, PatternFill, Alignment
     from openpyxl.utils.dataframe import dataframe_to_rows

     OPENPYXL_AVAILABLE = True
 except Exception:
     OPENPYXL_AVAILABLE = False

 try:
     # PyOD는 다양한 비지도 이상치 알고리즘 제공(가능하면 사용)
     from pyod.models.iforest import IForest as PyODIForest  # type: ignore

     PYOD_AVAILABLE = True
 except Exception:
     PYOD_AVAILABLE = False

+# ----- Constants ---------------------------------------------------------------
+DEFAULT_STAGE3_SHEET = "통합_원본데이터_Fixed"
+
+
 # ----- Logging ----------------------------------------------------------------
 logger = logging.getLogger("hvdc.anomaly")
 if not logger.handlers:
     logging.basicConfig(
         level=logging.INFO,
         format="%(asctime)s | %(levelname)s | %(message)s",
     )


 # ----- Domain enums / schema ---------------------------------------------------
 class AnomalyType(Enum):
     TIME_REVERSAL = "시간 역전"
     LOCATION_SKIP = "위치 스킵"
     EXCESSIVE_DWELL = "과도 체류"
     ML_OUTLIER = "머신러닝 이상치"
     DATA_QUALITY = "데이터 품질"


 class AnomalySeverity(Enum):
     CRITICAL = "치명적"
     HIGH = "높음"
     MEDIUM = "보통"
     LOW = "낮음"


@@ -622,94 +626,134 @@ class HybridAnomalyDetector:
             row = a.to_dict()
             for cidx, c in enumerate(cols, start=1):
                 ws2.cell(ridx, cidx).value = row.get(
                     c if c != "risk_score" else "Risk_Score"
                 )

         # Features
         ws3 = wb.create_sheet("Features")
         for r in dataframe_to_rows(feat.reset_index(), index=False, header=True):
             ws3.append(r)

         wb.save(path)
         logger.info(f"Excel 저장: {path}")


 # -------- convenience runner ---------------------------------------------------
 cfg = DetectorConfig()
 fb = FeatureBuilder(cfg)


 def main():
     import argparse

     ap = argparse.ArgumentParser()
     ap.add_argument("--input", required=True, help="Excel/CSV 파일 경로")
-    ap.add_argument("--sheet", default=None, help="Excel 시트명(옵션)")
+    ap.add_argument(
+        "--sheet",
+        default=DEFAULT_STAGE3_SHEET,
+        help="Excel 시트명(기본: Stage 3 산출물 '통합_원본데이터_Fixed')",
+    )
     ap.add_argument("--excel-out", default=None, help="결과 Excel 경로")
     ap.add_argument("--json-out", default=None, help="결과 JSON 경로")
     ap.add_argument("--visualize", action="store_true", help="원본 파일에 색상 표시")
     ap.add_argument("--case-col", default="Case No.", help="Case NO 컬럼명")
     ap.add_argument("--no-backup", action="store_true", help="백업 생성 안함")
     args = ap.parse_args()

     p = Path(args.input)
+    sheet_name = args.sheet or DEFAULT_STAGE3_SHEET
     if p.suffix.lower() in (".xlsx", ".xlsm", ".xls"):
-        df = pd.read_excel(p, sheet_name=args.sheet)
+        try:
+            df = pd.read_excel(p, sheet_name=sheet_name)
+        except ValueError:
+            try:
+                available_sheets = pd.ExcelFile(p).sheet_names
+            except Exception:
+                available_sheets = []
+            sheet_list = ", ".join(available_sheets) if available_sheets else "(시트 정보 없음)"
+            logger.error(
+                "❌ 시트 로딩 실패: '%s' 시트를 찾을 수 없습니다. Stage 3에서 생성된 "
+                "'통합_원본데이터_Fixed' 시트를 사용하거나 --sheet 옵션으로 존재하는 시트를 지정하세요. "
+                "사용 가능한 시트: %s",
+                sheet_name,
+                sheet_list,
+            )
+            return
     else:
         df = pd.read_csv(p, encoding="utf-8")

     # DataFrame인지 확인
     if not isinstance(df, pd.DataFrame):
         logger.error(f"데이터 로딩 실패: {type(df)}")
         return

     det = HybridAnomalyDetector(cfg)
     result = det.run(df, export_excel=args.excel_out, export_json=args.json_out)

     s = result["summary"]
     logger.info(f"총 이상치: {s['total']}")
     logger.info(f"유형별: {s['by_type']}")
     logger.info(f"심각도별: {s['by_severity']}")

     # 색상 시각화 옵션
     if args.visualize:
         try:
             from anomaly_visualizer import AnomalyVisualizer

             logger.info("🎨 원본 파일에 색상 표시 시작...")
             visualizer = AnomalyVisualizer(result["anomalies"])

+            if p.suffix.lower() not in (".xlsx", ".xlsm", ".xls"):
+                logger.error("❌ 색상 표시는 Excel 파일에서만 지원됩니다.")
+                return
+
+            try:
+                available_sheets = pd.ExcelFile(args.input).sheet_names
+            except Exception as exc:
+                logger.error(f"❌ Excel 시트 정보를 읽는 중 오류가 발생했습니다: {exc}")
+                return
+
+            if sheet_name not in available_sheets:
+                logger.error(
+                    "❌ '%s' 시트를 찾을 수 없어 색상 표시를 진행할 수 없습니다. Stage 3 산출물의 "
+                    "'통합_원본데이터_Fixed' 시트를 사용하거나 --sheet 옵션으로 존재하는 시트를 지정하세요. "
+                    "사용 가능한 시트: %s",
+                    sheet_name,
+                    ", ".join(available_sheets),
+                )
+                return
+
             viz_result = visualizer.apply_anomaly_colors(
                 excel_file=args.input,
-                sheet_name=args.sheet or "Case List",
+                sheet_name=sheet_name,
                 case_col=args.case_col,
                 create_backup=not args.no_backup,
             )

             if viz_result["success"]:
                 # 색상 범례 추가
-                visualizer.add_color_legend(args.input, args.sheet or "Case List")
+                visualizer.add_color_legend(args.input, sheet_name)
                 logger.info("ℹ️ 범례는 '색상 범례' 시트에만 작성되어 데이터 행에는 영향을 주지 않습니다.")
                 logger.info(f"✅ 색상 표시 완료: {viz_result['message']}")
                 logger.info(
                     f"  - 시간 역전: {viz_result['time_reversal_count']}건 (빨강)"
                 )
                 logger.info(
                     f"  - ML 이상치: {viz_result['ml_outlier_count']}건 (주황/노랑)"
                 )
                 logger.info(
                     f"  - 데이터 품질: {viz_result['data_quality_count']}건 (보라)"
                 )
                 if viz_result.get("backup_path"):
                     logger.info(f"  - 백업 파일: {viz_result['backup_path']}")
             else:
                 logger.error(f"❌ 색상 표시 실패: {viz_result['message']}")

         except ImportError as e:
             logger.error(f"❌ AnomalyVisualizer 모듈을 찾을 수 없습니다: {e}")
         except Exception as e:
             logger.error(f"❌ 색상 표시 중 오류 발생: {e}")


 if __name__ == "__main__":
     main()
diff --git a/hvdc_pipeline/scripts/stage4_anomaly/anomaly_visualizer.py b/hvdc_pipeline/scripts/stage4_anomaly/anomaly_visualizer.py
index e9e210ad970477ec3cd30aa6305ba5ad406c04e2..5fb06f12586c8bb55511a7e58ab7d20882d258ad 100644
--- a/hvdc_pipeline/scripts/stage4_anomaly/anomaly_visualizer.py
+++ b/hvdc_pipeline/scripts/stage4_anomaly/anomaly_visualizer.py
@@ -1,36 +1,38 @@
 # -*- coding: utf-8 -*-
 from __future__ import annotations
 import re, shutil
 from datetime import datetime
 from pathlib import Path
 from typing import Dict, Iterable, List, Optional, Tuple, Union

 import openpyxl
 from openpyxl.styles import PatternFill

 # ---- ARGB 정의(불투명: FF alpha). 검증 스크립트 호환 위해 00/FF 모두 허용 ----
+DEFAULT_STAGE3_SHEET = "통합_원본데이터_Fixed"
+
 ARGB = {
     "RED":    ("FFFF0000", {"FFFF0000", "00FF0000"}),
     "ORANGE": ("FFFFC000", {"FFFFC000", "00FFC000"}),
     "YELLOW": ("FFFFFF00", {"FFFFFF00", "00FFFF00"}),
     "PURPLE": ("FFCC99FF", {"FFCC99FF", "00CC99FF"}),
 }

 DATE_KEYWORDS = {
     # 한글/영문 혼합 키워드(15개 이상)
     "date","day","time","dt","입고","출고","도착","출발","반출","반입","통관",
     "선적","출항","입항","검수","검품","warehouse","site"
 }

 def _norm_case(s: object) -> str:
     """Case ID 정규화: 공백/특수문자 제거 + 대문자."""
     return re.sub(r"[^A-Z0-9]", "", str(s).strip().upper()) if s is not None else ""

 def _is_date_col(header: str, sample_vals: List[object]) -> bool:
     h = str(header).strip().lower()
     if any(k in h for k in DATE_KEYWORDS):
         return True
     # 값 기반 휴리스틱: 30% 이상이 날짜로 파싱 가능하면 날짜열로 간주
     import pandas as pd
     s = pd.to_datetime(pd.Series(sample_vals), errors="coerce")
     non_na = s.notna().mean() if len(s) else 0.0
@@ -38,51 +40,51 @@ def _is_date_col(header: str, sample_vals: List[object]) -> bool:

 def _fill(cell, argb: str):
     cell.fill = PatternFill(fill_type="solid", start_color=argb, end_color=argb)

 class AnomalyVisualizer:
     """
     anomalies: List[dict|dataclass] — dict 키는 Anomaly_Type/Severity/Case_ID
     """
     def __init__(self, anomalies: Iterable[object]):
         self.records: List[Dict] = []
         for a in anomalies:
             if hasattr(a, "to_dict"):
                 self.records.append(a.to_dict())
             elif isinstance(a, dict):
                 self.records.append(a)
         # Case → anomaly 목록(중복 허용)
         self.by_case: Dict[str, List[Dict]] = {}
         for r in self.records:
             cid = _norm_case(r.get("Case_ID", ""))
             if cid:
                 self.by_case.setdefault(cid, []).append(r)

     def apply_anomaly_colors(
         self,
         excel_file: Union[str, Path],
-        sheet_name: str = "Case List",
+        sheet_name: str = DEFAULT_STAGE3_SHEET,
         case_col: str = "Case No.",
         create_backup: bool = True,
     ) -> Dict:
         excel_file = Path(excel_file)
         if create_backup:
             ts = datetime.now().strftime("%Y%m%d_%H%M%S")
             bak = excel_file.with_name(f"{excel_file.stem}.backup_{ts}{excel_file.suffix}")
             shutil.copyfile(excel_file, bak)

         wb = openpyxl.load_workbook(excel_file, keep_vba=excel_file.suffix.lower()==".xlsm")
         if sheet_name not in wb.sheetnames:
             return {"success": False, "message": f"시트 없음: {sheet_name}"}
         ws = wb[sheet_name]

         # 헤더 스캔 → case 컬럼 index
         header = [ws.cell(row=1, column=c).value for c in range(1, ws.max_column+1)]
         case_col_idx = None
         for c, name in enumerate(header, 1):
             if name and "case" in str(name).lower():
                 case_col_idx = c; break
         if not case_col_idx:
             return {"success": False, "message": "Case NO 열을 찾지 못함"}

         # 날짜열 식별(헤더 + 샘플 기반)
         date_cols: List[int] = []
@@ -114,51 +116,53 @@ class AnomalyVisualizer:
                     # 심각도: CRITICAL/HIGH→주황, MEDIUM/LOW→노랑
                     if sev in ("치명적","높음","HIGH","CRITICAL"):
                         paint_row = "ORANGE" if paint_row != "ORANGE" else paint_row
                     else:
                         paint_row = "YELLOW" if paint_row not in ("ORANGE",) else paint_row
                 elif atype == "데이터 품질":
                     paint_row = "PURPLE"

             if paint_row:
                 argb = ARGB[paint_row][0]
                 for c in range(1, ws.max_column+1):
                     _fill(ws.cell(row=r, column=c), argb)
                 if paint_row == "PURPLE":
                     cnt["data_quality"] += 1
                 else:
                     cnt["ml_outlier"] += 1

         wb.save(excel_file)
         return {
             "success": True,
             "message": f"색상 적용 완료 (시간역전={cnt['time_reversal']}, ML={cnt['ml_outlier']}, 품질={cnt['data_quality']})",
             **cnt,
             "backup_path": str(bak) if create_backup else None,
         }

-    def add_color_legend(self, excel_file: Union[str, Path], _: str = "Case List") -> None:
+    def add_color_legend(
+        self, excel_file: Union[str, Path], _: str = DEFAULT_STAGE3_SHEET
+    ) -> None:
         """
         ⚠️ 기존과 달리 '데이터 시트'를 건드리지 않고, 항상 별도 시트('색상 범례')에 작성.
         """
         excel_file = Path(excel_file)
         wb = openpyxl.load_workbook(excel_file, keep_vba=excel_file.suffix.lower()==".xlsm")
         name = "색상 범례"
         if name in wb.sheetnames:
             ws = wb[name]
             ws.delete_rows(1, ws.max_row)
         else:
             ws = wb.create_sheet(name)

         ws["A1"] = "이상치 색상 범례"
         ws["B2"] = "시간 역전";     _fill(ws["A2"], ARGB["RED"][0])
         ws["B3"] = "ML 이상치(높음/치명적)"; _fill(ws["A3"], ARGB["ORANGE"][0])
         ws["B4"] = "ML 이상치(보통/낮음)";   _fill(ws["A4"], ARGB["YELLOW"][0])
         ws["B5"] = "데이터 품질";   _fill(ws["A5"], ARGB["PURPLE"][0])

         wb.save(excel_file)
 import re, shutil
 from datetime import datetime
 from pathlib import Path
 from typing import Dict, Iterable, List, Optional, Tuple, Union

 import openpyxl
@@ -194,51 +198,51 @@ def _is_date_col(header: str, sample_vals: List[object]) -> bool:

 def _fill(cell, argb: str):
     cell.fill = PatternFill(fill_type="solid", start_color=argb, end_color=argb)

 class AnomalyVisualizer:
     """
     anomalies: List[dict|dataclass] — dict 키는 Anomaly_Type/Severity/Case_ID
     """
     def __init__(self, anomalies: Iterable[object]):
         self.records: List[Dict] = []
         for a in anomalies:
             if hasattr(a, "to_dict"):
                 self.records.append(a.to_dict())
             elif isinstance(a, dict):
                 self.records.append(a)
         # Case → anomaly 목록(중복 허용)
         self.by_case: Dict[str, List[Dict]] = {}
         for r in self.records:
             cid = _norm_case(r.get("Case_ID", ""))
             if cid:
                 self.by_case.setdefault(cid, []).append(r)

     def apply_anomaly_colors(
         self,
         excel_file: Union[str, Path],
-        sheet_name: str = "Case List",
+        sheet_name: str = DEFAULT_STAGE3_SHEET,
         case_col: str = "Case No.",
         create_backup: bool = True,
     ) -> Dict:
         excel_file = Path(excel_file)
         if create_backup:
             ts = datetime.now().strftime("%Y%m%d_%H%M%S")
             bak = excel_file.with_name(f"{excel_file.stem}.backup_{ts}{excel_file.suffix}")
             shutil.copyfile(excel_file, bak)

         wb = openpyxl.load_workbook(excel_file, keep_vba=excel_file.suffix.lower()==".xlsm")
         if sheet_name not in wb.sheetnames:
             return {"success": False, "message": f"시트 없음: {sheet_name}"}
         ws = wb[sheet_name]

         # 헤더 스캔 → case 컬럼 index
         header = [ws.cell(row=1, column=c).value for c in range(1, ws.max_column+1)]
         case_col_idx = None
         for c, name in enumerate(header, 1):
             if name and "case" in str(name).lower():
                 case_col_idx = c; break
         if not case_col_idx:
             return {"success": False, "message": "Case NO 열을 찾지 못함"}

         # 날짜열 식별(헤더 + 샘플 기반)
         date_cols: List[int] = []
@@ -270,45 +274,47 @@ class AnomalyVisualizer:
                     # 심각도: CRITICAL/HIGH→주황, MEDIUM/LOW→노랑
                     if sev in ("치명적","높음","HIGH","CRITICAL"):
                         paint_row = "ORANGE" if paint_row != "ORANGE" else paint_row
                     else:
                         paint_row = "YELLOW" if paint_row not in ("ORANGE",) else paint_row
                 elif atype == "데이터 품질":
                     paint_row = "PURPLE"

             if paint_row:
                 argb = ARGB[paint_row][0]
                 for c in range(1, ws.max_column+1):
                     _fill(ws.cell(row=r, column=c), argb)
                 if paint_row == "PURPLE":
                     cnt["data_quality"] += 1
                 else:
                     cnt["ml_outlier"] += 1

         wb.save(excel_file)
         return {
             "success": True,
             "message": f"색상 적용 완료 (시간역전={cnt['time_reversal']}, ML={cnt['ml_outlier']}, 품질={cnt['data_quality']})",
             **cnt,
             "backup_path": str(bak) if create_backup else None,
         }

-    def add_color_legend(self, excel_file: Union[str, Path], _: str = "Case List") -> None:
+    def add_color_legend(
+        self, excel_file: Union[str, Path], _: str = DEFAULT_STAGE3_SHEET
+    ) -> None:
         """
         ⚠️ 기존과 달리 '데이터 시트'를 건드리지 않고, 항상 별도 시트('색상 범례')에 작성.
         """
         excel_file = Path(excel_file)
         wb = openpyxl.load_workbook(excel_file, keep_vba=excel_file.suffix.lower()==".xlsm")
         name = "색상 범례"
         if name in wb.sheetnames:
             ws = wb[name]
             ws.delete_rows(1, ws.max_row)
         else:
             ws = wb.create_sheet(name)

         ws["A1"] = "이상치 색상 범례"
         ws["B2"] = "시간 역전";     _fill(ws["A2"], ARGB["RED"][0])
         ws["B3"] = "ML 이상치(높음/치명적)"; _fill(ws["A3"], ARGB["ORANGE"][0])
         ws["B4"] = "ML 이상치(보통/낮음)";   _fill(ws["A4"], ARGB["YELLOW"][0])
         ws["B5"] = "데이터 품질";   _fill(ws["A5"], ARGB["PURPLE"][0])

         wb.save(excel_file)
\ No newline at end of file
