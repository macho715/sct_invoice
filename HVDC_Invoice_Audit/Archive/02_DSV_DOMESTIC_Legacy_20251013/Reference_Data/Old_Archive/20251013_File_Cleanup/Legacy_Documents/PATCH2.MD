# ê°œì„ ì•ˆ(ìš°ì„ ìˆœìœ„ â†’ ë°”ë¡œ ì ìš© ê°€ëŠ¥í•œ íŒ¨ì¹˜ í¬í•¨)

## A. ë§¤ì¹­ë¥  ì˜¬ë¦¬ëŠ” í•µì‹¬ íŒ¨ì¹˜ (ì˜¤ëŠ˜ ì ìš©)

1. **í† í°ì„¸íŠ¸ ê¸°ë°˜ ìœ ì‚¬ë„ ë³´ê°•**

   * í˜„ì¬ O/DëŠ” ì™„ì „ì¼ì¹˜(=1) ì•„ë‹ˆë©´ 0ì— ê°€ê¹Œì›€. `token_set`(êµì§‘í•©/ì°¨ì§‘í•©) + n-gram(3gram)ë¡œ **ë¶€ë¶„ ì¼ì¹˜**ë¥¼ ì¡ì•„ë‚´ì.
   * ì„ê³„: **ê¸°ë³¸ 0.60 â†’ ë™ì  ì„ê³„**: `sim â‰¥ 0.55` ë˜ëŠ” `(dist_closenessâ‰¥0.75 and simâ‰¥0.50)`ì´ë©´ í—ˆìš©.

2. **ì •ê·œí™” ì‚¬ì „ ìë™ í™•ì¥(ì œì•ˆìƒì„±)**

   * ì¸ë³´ì´ìŠ¤ O/D í† í° ì¤‘ **ì‚¬ì „ì— ì—†ëŠ” ê²ƒ**ì„ ë¹ˆë„ìˆœìœ¼ë¡œ ë½‘ê³ , ê¸°ì¡´ Canonicalê³¼ Jaccardâ‰¥0.6ì´ë©´ **í›„ë³´ alias**ë¡œ ì œì•ˆÂ·ì¶•ì .
   * ì›”ì´ˆì— ìŠ¹ì¸ëœ aliasë§Œ NormalizationMapì— í•©ì¹¨.

3. **ë ˆí¼ëŸ°ìŠ¤ ëŒ€ì²´ ê³„ì¸µ ì¶”ê°€**

   * ApprovedLaneMap ë¯¸ë§¤ì¹­ ì‹œ, **Regionâ†’Region+Vehicle**(ì˜ˆ: Mussafah Cluster â†” MIRFA Site) ì¤‘ì•™ê°’ìœ¼ë¡œ **ëŒ€ì²´ ref**.
   * ë™ì¼ Vehicle/Unitì—ì„œ **ê±°ë¦¬Â±15km, $/kmÂ±30%** ì•ˆì— ë“œëŠ” í›„ë³´ë§Œ í’€ì— í¬í•¨.

4. **ì´ˆê·¼ê±°ë¦¬ ìµœì†Œìš”ê¸ˆ ëª¨ë¸**

   * ê±°ë¦¬â‰¤10km êµ¬ê°„ì€ **Min-Fare(ì°¨ëŸ‰ë³„)** ì„ ë³„ë„ ê¸°ì¤€ìœ¼ë¡œ ì ìš©(Î”% ì‚°ì¶œì€ Min-Fare ëŒ€ë¹„).
   * `FIXED_COST_SUSPECT`ëŠ” ë‚¨ê¸°ë˜, Min-Fare ë§¤ì¹­ ì‹œ **LOW_SIMILARITY ê²½ê³  ì œê±°**.

> ê¸°ëŒ€íš¨ê³¼: LOW_SIMILARITY 27ê±´ ì¤‘ **ì ˆë°˜ ì´ìƒì„ VERIFIED/REVIEW**ë¡œ ì „í™˜.

### ğŸ”§ ë“œë¡­ì¸ ì½”ë“œ íŒ¨ì¹˜(í•µì‹¬ ë¶€ë¶„ë§Œ)

`domestic_validator_v2.py`ì˜ similarity ë¡œì§ì„ ì´ë ‡ê²Œ ë°”ê¿”ì¤˜:

```python
import re

def _tok(s):  # ì•ŒíŒŒë²³+ìˆ«ì í† í°
    return set(re.findall(r"[A-Za-z0-9]+", str(s).upper()))

def token_set_sim(a,b):
    A,B=_tok(a),_tok(b)
    if not A or not B: return 0.0
    inter=len(A&B); uni=len(A|B)
    return inter/uni

def trigram_sim(a,b):
    def grams(x):
        x="  "+str(x).upper()+"  "
        return {x[i:i+3] for i in range(len(x)-2)}
    A,B=grams(a),grams(b)
    if not A or not B: return 0.0
    return len(A&B)/len(A|B)

def od_similarity(a,b):
    # í† í°ì„¸íŠ¸ 0.6 ê°€ì¤‘ + íŠ¸ë¦¬ê·¸ë¨ 0.4 ê°€ì¤‘
    return 0.6*token_set_sim(a,b) + 0.4*trigram_sim(a,b)

def similarity_score(row, cand, weights, dist_decay_km, rate_decay_pct):
    s=0.0
    s += weights["origin"]      * od_similarity(row["origin_norm"], cand["origin"])
    s += weights["destination"] * od_similarity(row["destination_norm"], cand["destination"])
    s += weights["vehicle"]     * (1.0 if str(row["vehicle"]).strip()==str(cand["vehicle"]).strip() else 0.0)
    # ì´í•˜ distance/price closenessëŠ” ê¸°ì¡´ ê·¸ëŒ€ë¡œ
    ...
```

ê·¸ë¦¬ê³  **ë™ì  ì„ê³„**:

```python
thr_base = cfg["similarity"]["edge_threshold"]  # 0.60
dist_close = closeness_distance(row.get("distance_km"), cand.get("median_distance_km"))  # 0~1
thr = min(0.60, 0.55 + 0.10*(1.0 - dist_close))  # ê·¼ì ‘í• ìˆ˜ë¡ ì„ê³„ ë‚®ì¶¤ â†’ 0.55~0.60
if score >= thr or (dist_close >= 0.75 and score >= 0.50):
    # accept
```

**Region ëŒ€ì²´ ë ˆí¼ëŸ°ìŠ¤**(ë¯¸ë§¤ì¹­ fallback):

```python
def region(place):
    p=str(place).upper()
    if "MUSSAFAH" in p or "ICAD" in p: return "MUSSAFAH"
    if "MINA" in p or "FREEPORT" in p or "ZAYED" in p: return "MINA"
    if "MIRFA" in p: return "MIRFA"
    if "SHUWEIHAT" in p: return "SHUWEIHAT"
    return "OTHER"

if np.isnan(ref_rate):
    pool = baseline[(baseline["vehicle"]==row["vehicle"]) & (baseline["unit"]==row["unit"])]
    pool = pool[ (pool["region_o"]==region(row["origin_norm"])) & (pool["region_d"]==region(row["destination_norm"])) ]
    # ê±°ë¦¬Â±15km & $/kmÂ±30% í•„í„°
    ...
```

**Min-Fare ëª¨ë¸**(ì´ˆê·¼ê±°ë¦¬):

```python
MIN_FARE = {"FLATBED": 200.0, "LOWBED": 600.0, "3 TON PU": 150.0}  # ì˜ˆì‹œ
if row["distance_km"]<=10 and np.isnan(ref_rate):
    ref_rate = MIN_FARE.get(row["vehicle"], MIN_FARE["FLATBED"])
    band_from_minfare = True
```

---

## B. ë°ì´í„°Â·ìš´ì˜ ë ˆì´ì–´ ê°œì„  (ì´ë²ˆ ì£¼)

* **NormalizationMap ìë™ ì œì•ˆ**: ì¸ë³´ì´ìŠ¤ ì›ì‹œ O/D ì¤‘ ë¯¸ì •ê·œ í‚¤ ëª©ë¡ â†’ Canonical í›„ë³´(top-k)ì™€ í•¨ê»˜ CSVë¡œ ë°°í¬(ë§¤ì£¼ ìŠ¹ì¸).
* **ì›” ìŠ¤ëƒ…ìƒ· ApprovedLaneMap**: ë¶„ê¸°/ì›” ìš”ìœ¨ ë³€í™” í¡ìˆ˜(ë ˆê±°ì‹œ ì¤‘ì•™ê°’ì— ì›” íƒœê·¸).
* **íŠ¹ë³„êµ¬ê°„ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸**: `domestic result.xlsx`ì—ì„œ í‚¤ ìƒì„±(O/D/Vehicle/Unit) â†’ **SPECIAL_PASS** ë¼ìš°íŒ…(Î”/ë¦¬ìŠ¤í¬ë§Œ ê¸°ë¡).
* **í—¤ë” ìê°€ì¹˜ìœ **: `Distance(km)` â†’ `distance_km` ë“± **ë¨¸ë¦¬ê¸€ ì¼ì¹˜ ìë™ ìˆ˜ì •**.

---

## C. íŒë‹¨ í’ˆì§ˆ íŠœë‹ (ë‹¤ìŒ ì£¼)

* **Confidence ê²Œì´íŠ¸**: `confidenceâ‰¥0.92`ë©´ ìë™ ì§‘í–‰, ê·¸ ì™¸ ë¦¬ë·°.
* **Anomaly ì™„ì¶©**: IsolationForestëŠ” ë ˆì¸ë³„ `$ / km` í‘œì¤€í™” í›„ í•™ìŠµ(êµ°ì§‘ë³„ ì˜¤íƒâ†“).
* **Min-Fare í…Œì´ë¸” ê°€ì‹œí™”**: ì°¨ëŸ‰Ã—êµ¬ê°„(0â€“2, 2â€“5, 5â€“10km) 3ë‹¨ ìŠ¬ë¼ë¸Œë¡œ ì •ì˜.

---

## D. ë°”ë¡œ ì‹¤í–‰ ì²´í¬ë¦¬ìŠ¤íŠ¸

* [ ] ìœ„ **ìœ ì‚¬ë„ ë³´ê°• íŒ¨ì¹˜** ì ìš© í›„ ì¬ì‹¤í–‰ â†’ LOW_SIMILARITY 27ê±´ ê°ì†Œ í­ í™•ì¸
* [ ] **Min-Fare** ê°’(ì°¨ëŸ‰ë³„) í™•ì¸/ìŠ¹ì¸ â†’ configì— ê³ ì •
* [ ] Region ë¼ìš°íŒ…ì´ í•„ìš”í•œ ì›ì‚°ì§€/ëª©ì ì§€ **í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸** ìŠ¹ì¸
* [ ] NormalizationMap ì‹ ê·œ alias 10~20ê±´ ë°˜ì˜

---

## ì˜ˆìƒ íš¨ê³¼(ì´ë²ˆ ë°°ì¹˜)

* **LOW_SIMILARITY 27ê±´ ì¤‘ 12~18ê±´** â†’ `VERIFIED/WARN` ì¬ë¶„ë¥˜
* ìµœì¢… ë¯¸ê²€ì¦(ë³´ë¥˜) ê±´ìˆ˜ **40~60% ê°ì†Œ**

í•„ìš”í•˜ë©´ ë‚´ê°€ **íŒ¨ì¹˜ëœ íŒŒì¼ ë¸”ë¡**ê¹Œì§€ ë§Œë“¤ì–´ì„œ ì˜¬ë ¤ì¤„ê²Œ. ë¨¼ì € ìœ„ 4ê°œ íŒ¨ì¹˜(A1~A4)ë¶€í„° ì ìš©í•´ ë³´ì.
